---
title: "Analysis of synthetic data using WCLS"
author: "Tianchen Qian"
date: "May 30, 2021"
output: pdf_document
fig_width: 4
fig_height: 3 
---


The data here is a synthetic data set mimicking some features of the HeartSteps
data set.

## 1. Preparation

We load the already generated synthetic data set and load some packages and functions
required to carry out the WCLS analysis.

```{r message=FALSE, preparation}
rm(list = ls())

library(tidyverse)
library(xtable)
library(geepack)
source("xgeepack.R")
source("estimate.R")

synthetic_data <- read.csv("synthetic_data_37subject_210time.csv")

summary(synthetic_data)
```

The variable names are kept consistent with the original HeartSteps data set and
the analysis code for that data, the analysis result of which is included in the
main manuscript. Below are some explanation for each of the variables:

* userid: id of a user (ranging from 1 to 37)
* decision.index.nogap: decision point index for each user (ranging from 1 to 210)
* study.day.nogap: day in the study for each user (ranging from 0 to 41)
* jbsteps30.log: log-transformed 30-minute step count following each decision point
(it is called jbsteps because in HeartSteps the step count was measured by Jawbone tracker)
* jbsteps30.log.lag1: log-transformed 30-minute step count following the previous decision point;
i.e., a lagged version of jbsteps30.log
* jbsteps30pre.log: log-transformed step count in the 30-minute window *preceding* each decision point
* location.homework: an indicator of whether the user is currently at home/work (1) or other places (0)
* send: treatment indicator, whether an activity suggestion was sent at the decision point
* avail: availability indicator, whether the person is available at the decision point


We create two additional variables to be used in the WCLS regression below.

```{r, createvars}
synthetic_data$"(Intercept)" <- 1
synthetic_data$"I(send - 0.6)" <- synthetic_data$send - 0.6
```

## 2. Using WCLS to analyze the data ------------------------------------------

We use the Weighted and Centered Least Squares (WCLS) estimator to analyze the data.

### 2.1. Marginal Effect

In this analysis, we aim to answer the question: "What is the effect of
delivering activity suggestions on individualsâ€™ subsequent 30-minute step counts?"

```{r, analysis1}
xmat <- synthetic_data %>%
    transmute("(Intercept)" = .$"(Intercept)",
              "jbsteps30pre.log" = .$"jbsteps30pre.log",
              "I(send - 0.6)" = .$"I(send - 0.6)")

fit_model1 <- geese.glm(x = as.matrix(xmat),
                        y = synthetic_data$jbsteps30.log,
                        w = synthetic_data$avail,
                        id = as.factor(synthetic_data$user),
                        family = gaussian(), corstr = "independence")
estimate(fit_model1)
```

The estimated marginal effect of is the coefficient for I(send - 0.6).

One can use a different set of control variables (e.g., by additionally including
the lag-1 outcome) in the estimation of the same marginal effect:

```{r, analysis1.1}
xmat <- synthetic_data %>%
    transmute("(Intercept)" = .$"(Intercept)",
              "jbsteps30pre.log" = .$"jbsteps30pre.log",
              "jbsteps30.log.lag1" = .$"jbsteps30.log.lag1",
              "I(send - 0.6)" = .$"I(send - 0.6)")

fit_model1.1 <- geese.glm(x = as.matrix(xmat),
                        y = synthetic_data$jbsteps30.log,
                        w = synthetic_data$avail,
                        id = as.factor(synthetic_data$user),
                        family = gaussian(), corstr = "independence")
estimate(fit_model1.1)
```

The estimated marginal effect of is again the coefficient for I(send - 0.6).
We see that the estimated marginal effect here is similar to the previous analysis
in magnitude, and the standard error is slightly smaller. This illustrates the 
fact that including control variables that is correlated with the proximal outcome
can usually reduce noise and improve estimation precision.

### 2.2. Effect Change Over Time

In this analysis, we aim to answer the question: "How does the effect of
activity suggestions change with each additional day in the study?"

```{r, analysis2}
xmat <- synthetic_data %>%
    transmute("(Intercept)" = .$"(Intercept)",
              "jbsteps30pre.log" = .$"jbsteps30pre.log",
              "study.day.nogap" = .$"study.day.nogap",
              "I(send - 0.6)" = .$"I(send - 0.6)",
              "I(send - 0.6):study.day.nogap" =
                  .$"I(send - 0.6)" * .$"study.day.nogap")

fit_model2 <- geese.glm(x = as.matrix(xmat),
                        y = synthetic_data$jbsteps30.log,
                        w = synthetic_data$avail,
                        id = as.factor(synthetic_data$user),
                        family = gaussian(), corstr = "independence")
estimate(fit_model2)

```

We make the plot of the estimated effect over time along with its pointwise
95% confidence interval.

```{r, analysis2 plot}
beta_index <- 4:5

beta_hat <- coef(fit_model2)[beta_index]
vcov <- fit_model2$geese$vbeta[beta_index, beta_index]

newdta <- df_tx <- data.frame(Intercept = 1, study.day.nogap = 0:41)
df_tx$treatment_effect <- as.matrix(newdta) %*% beta_hat
df_tx$tx_se <- NA
for (i in 1:nrow(df_tx)) {
    f_t <- as.numeric(newdta[i, ]) # feature
    df_tx$tx_se[i] <- sqrt(t(f_t) %*% vcov %*% f_t)
}
df_tx$left_ci <- df_tx$treatment_effect - 1.96 * df_tx$tx_se
df_tx$right_ci <- df_tx$treatment_effect + 1.96 * df_tx$tx_se

df_tx_linear <- df_tx


ggplot(df_tx) + 
    geom_line(aes(x = study.day.nogap, y = treatment_effect), color = "blue") +
    geom_ribbon(aes(ymin = left_ci, ymax = right_ci, x = study.day.nogap),
                alpha = 0.3, fill = "blue") +
    geom_hline(yintercept = 0, color = "black") +
    xlab(label = "day in the study") +
    ylab(label = "treatment effect\n(on log step count)") +
    ggtitle(paste0("Effect of activity suggestion over time")) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))
```


### 2.3. Effect Moderated by Outcome at Previous Time Point

In this analysis, we aim to answer the question: "How does the effect of
activity suggestions depend on the logged step count at previous decision point?"


```{r, analysis3}
xmat <- synthetic_data %>%
    transmute("(Intercept)" = .$"(Intercept)",
              "jbsteps30pre.log" = .$"jbsteps30pre.log",
              "jbsteps30.log.lag1" = .$"jbsteps30.log.lag1",
              "location.homework" = .$"location.homework",
              "I(send - 0.6)" = .$"I(send.active - 0.6)",
              "I(send - 0.6):jbsteps30.log.lag1" =
                  .$"I(send - 0.6)" * .$"jbsteps30.log.lag1")

fit_model3 <- geese.glm(x = as.matrix(xmat),
                        y = synthetic_data$jbsteps30.log,
                        w = synthetic_data$avail,
                        id = as.factor(synthetic_data$user),
                        family = gaussian(), corstr = "independence")
estimate(fit_model3)
```